# virgil-nginx-noise-link
Nginx module that implements Noise Socket Protocol by using Virgil Security infrastructure.

## Features ##

 - Own context in the Nginx server providing a functionality of TCP of a proxy.
 - Protection of traffic by means of [Noise Protocol](http://noiseprotocol.org/).
 - At the moment only `Noise_XX_25519_AESGCM_SHA256` noise protocol pattern is realized.

## Building of Nginx with the virgil-nginx-noise-link module:

#### list of dependences

* Autoconf
* Automake

for Centos 7:
* pcre
* pcre-devel
* pcre2
* pcre2-devel
* openssl-devel
* flex
* bison

#### Building

1. The virgil-nginx-noise-link module is tested with nginx-1.12.0.
2. Set [Noise-C](https://github.com/rweather/noise-c) library is necessary for building of the server.
* How to build `Noise-C` it is described in [Noise-C Documentation](http://rweather.github.io/noise-c/index.html).
* Installation of library `Noise-C` in system:

```bash
	$make install
```

 2. The example of a script for build of the nginx server with the module is located in `virgil-nginx-noise-link/example/nginx_configure.sh`.
 
 3. The example of a test configuration of the server is located in `virgil-nginx-noise-link/example/nginx.conf`. The configuration realizes a functionality of reverse proxy and a backend server working in one copy of nginx launched by the local machine. The configuration works as follows:

<table align = "center">
	<tr>
    <td>https://localhost/<td>-></td>
    	<td>internal redirect to `noise_link` context<td>-></td>
    	<td>td>proxy to backend over noise link<td>---></td>
	</tr>
    <tr>
    	<td>---></td>
        <td>`noise_link` context on the backend server<td>-></td>
    	<td>internal redirect to http context<td>-></td>
    	<td>access to the static page index.html "Welcome to nginx!"</td>
    </tr>
    <tr>
    </tr>
</table>

4. For operation of the `Noise Protocol` files of private keys are necessary for noise initiator(client) and noise responder (server). Keys are generated by means of the test utility of `echo-keygen` from library`Noise-C` (`noise-c/examples/echo/echo-keygen`). Use of the utility is described in [noise-c example echo](http://rweather.github.io/noise-c/example_echo.html). Examples of files of the generated keys `virgil-nginx-noise-link/example/server_key_25519` and `virgil-nginx-noise-link/example/client_key_25519`. 

## Basic directives ##

```nginx
Syntax: 	noise_link { ... }
Default: 	—
Context: 	main
```

Provides the configuration file context in which the noise link server directives are specified. 

```nginx
Syntax: 	server { ... } 
Default: 	— 
Context: 	noise_link
```
Sets the configuration for a server. 

```nginx
Syntax: 	listen address:port [noise] [udp] [backlog=number] [ipv6only=on|off] [reuseport] [so_keepalive=on|off|[keepidle]:[keepintvl]:[keepcnt]];
Default: 	—
Context: 	server
```

The `[noise]` parameter allows specifying that all connections accepted on this port should work in noise link mode. Defines that this link is used as noise responder (server). Remaining parameters are similar to the parameters described for the directive of [listen](http://nginx.org/en/docs/stream/ngx_stream_core_module.html#listen)  of the ngx_stream_core_module module.

```nginx
Syntax: 	nsoc_buffer_size size;
Default: 	nsoc_buffer_size 65519;
Context: 	noise_link, server
```
Specifies a size of the Noise transport message payload buffer for responder (server). Value by default is the maximum size of the payload determined in the specification [The Noise Protocol Framework](http://noiseprotocol.org/noise.html).

```nginx
Syntax: 	server_private_key_file file;
Default: 	—
Context: 	noise_link, server
```

Specifies a file with the secret key in the format of the simple sequence of bytes for the given noise responder (server). 

```nginx
Syntax: 	client_private_key_file file;
Default: 	—
Context: 	noise_link, server
```

Specifies a file with the secret key in the format of the simple sequence of bytes for the given noise initiator(client). 

```nginx
Syntax: 	proxy_noise on | off;
Default: 	proxy_noise off;
Context: 	noise_link, server
```
Enables the noise link protocol for connections to a proxied server. 

```nginx
Syntax: 	proxy_buffer_size size;
Default: 	proxy_buffer_size 65519;
Context: 	noise_link, server
```

Sets the size of the buffer used for reading data from the proxied server. Also sets the size of the buffer used for reading data from the client.  Value by default is the maximum size of the payload determined in the specification [The Noise Protocol Framework](http://noiseprotocol.org/noise.html). This parameter determines the buffer size for noise initiator(client) and shall be equal to the `nsoc_buffer_size` parameter for noise responder (server).

```nginx
Syntax: 	noise_handshake_timeout time;
Default: 	noise_handshake_timeout 60s;
Context: 	noise_link, server
```
Specifies a timeout for the `Noise Protocol` handshake to complete.

#### The module  supports also following directives:

`proxy_pass`, `proxy_bind`, `proxy_connect_timeout`, `proxy_timeout`, `proxy_upload_rate`, `proxy_download_rate`, `proxy_responses`, `proxy_next_upstream`, `proxy_next_upstream_tries`, `proxy_next_upstream_timeout`.<br />
The description of directives same, as for the [ngx_stream_proxy_module module](http://nginx.org/en/docs/stream/ngx_stream_proxy_module.html) only in `noise_link` context.<br />
`resolver`, `resolver_timeout`, `preread_timeout`, `tcp_nodelay`<br />
The description of directives same, as for the [ngx_stream_core_module module](http://nginx.org/en/docs/stream/ngx_stream_core_module.html) only in `noise_link` context.<br />

## Keepalive connection configuring

For setup of saving a noise link session it is possible to use the following directives of nginx for frontend server http: 
```nginx
http {
	...
    proxy_http_version 1.1;
    keepalive_requests 10;
    keepalive_timeout 50s;
	...
	server {
      ...
      location {
      	...
      	proxy_set_header Connection keep-alive;
        ...
      }
    }
    ustream name {
    	....
    	keepalive 1;
        ....
    }
}
    
```
Directives are designated by comments "###For the noise link connection keepalive setup...###" in the file of a test configuration `virgil-nginx-noise-link/example/nginx.conf`
